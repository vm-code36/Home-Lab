---
- name: Ensure /etc/apt/keyrings exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"

- name: Download Kubernetes Release.key (ASCII)
  ansible.builtin.get_url:
    url: "https://pkgs.k8s.io/core:/stable:/{{ kubernetes_major_minor }}/deb/Release.key"
    dest: /etc/apt/keyrings/kubernetes-apt-keyring.asc
    mode: "0644"

- name: Dearmor Kubernetes apt key
  ansible.builtin.command: >
    gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg /etc/apt/keyrings/kubernetes-apt-keyring.asc
  args:
    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

- name: Ensure Kubernetes key is world-readable
  ansible.builtin.file:
    path: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    mode: "0644"

- name: Add Kubernetes apt repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/{{ kubernetes_major_minor }}/deb/ /"
    filename: kubernetes
    state: present
    update_cache: true

- name: Determine exact Kubernetes package version (kubeadm) from apt-cache madison
  ansible.builtin.command: apt-cache madison kubeadm
  register: kubeadm_madison
  changed_when: false

- name: Extract Kubernetes install version from madison output
  ansible.builtin.set_fact:
    kube_install_ver: >-
      {{
        (kubeadm_madison.stdout_lines
          | select('search', kubernetes_madison_match)
          | list
          | first
        ).split('|')[1] | trim
      }}
  when: (kubeadm_madison.stdout_lines | select('search', kubernetes_madison_match) | list | length) > 0

- name: Debug resolved Kubernetes package version
  ansible.builtin.debug:
    msg: "Resolved kube version = {{ kube_install_ver }}"

- name: Fail if kube version could not be resolved
  ansible.builtin.fail:
    msg: "Could not resolve kubeadm version via apt-cache madison. Check repo/versions."
  when: kube_install_ver is not defined or kube_install_ver | length == 0

- name: Install kubeadm, kubelet, kubectl with exact version
  ansible.builtin.apt:
    name:
      - "kubeadm={{ kube_install_ver }}"
      - "kubelet={{ kube_install_ver }}"
      - "kubectl={{ kube_install_ver }}"
    state: present

- name: Hold kube packages (prevent upgrades)
  ansible.builtin.command: apt-mark hold kubelet kubeadm kubectl
  changed_when: false

- name: Compute node IP from interface
  ansible.builtin.set_fact:
    kubelet_node_ip: "{{ hostvars[inventory_hostname]['ansible_' + kubelet_node_ip_interface]['ipv4']['address'] }}"
  when: hostvars[inventory_hostname].get('ansible_' + kubelet_node_ip_interface) is not none

- name: Fallback node IP to default ipv4 if interface not found
  ansible.builtin.set_fact:
    kubelet_node_ip: "{{ ansible_default_ipv4.address }}"
  when: kubelet_node_ip is not defined or kubelet_node_ip | length == 0

- name: Set kubelet node-ip extra args
  ansible.builtin.copy:
    dest: /etc/default/kubelet
    mode: "0644"
    content: |
      KUBELET_EXTRA_ARGS=--node-ip={{ kubelet_node_ip }}
  notify: Restart kubelet

- name: Enable kubelet (it will stay in crashloop until joined; that's OK)
  ansible.builtin.systemd:
    name: kubelet
    enabled: true
    state: started

